
{% block content %}
<br>
<div id="chat-log" style="background-color: whitesmoke;
color: #182430;
width:100%;
height:500px;
margin-left: 1%;
padding: 1; overflow-y:scroll">
<!-- to load the previous messages of the selected room from the database #} -->
 {% for message in messages %}
{% if message.sender_user = user %}
<div style="float: right;">{{ message.sender_user}} {{
message.message }}</div>
{% else %} <div style="float: left;">{{ message.sender_user}} {{
message.message }}</div>
{% endif %}
<br>
{% endfor %}
</div>
<div style="margin-left: 1%; padding-top: 1%">
<input id="chat-message-input" type="text" size="60" style="width: 85%">&nbsp;
<input id="chat-message-submit" type="button" value="Send" style="width: 13%; color: white;
 background-color: #1B2430; ">
</div> 

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

{{ room_name|json_script:"room-name" }}

<script>
    // {# setting variables to display on the chat log #}
    var sender = '{{ sender_id }}';
    var receiver = '{{ receiver_id }}';
    var sender_name = '{{ sender_name }}';
    var user = '{{ user }}'
    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    // { setting the websocket route as per the selected room names}
    const chatSocket = new WebSocket(
    'Ws://'
    + window.location.host
    + '/ws/chat/'
    + roomName
    + '/'
    );

chatSocket.onmessage = function (e) {
     const data = JSON.parse(e.data);
// {# to enhance the chat log #)
if(data.sender_name == user){
$("#chat-log").append("<div style='float: right'>" +
data.sender_name + data.message + "</div><br>");
elsel
$("#chat-log").append("<div style='float: left'>" +
data.sender_name +
data.message + "</div><br>");
}
$("#chat-log" ).scrollTop($("#chat-log")[0].scrollHeight);
}
chatSocket.onclose = function (e) {
console.log('Error', e) 
console.error('Chat socket closed unexpectedly' );
};




// # Assuming you have defined the models (Message and Room) correctly here.

// # def post(self, request):
// #     sender = request.user.id
// #     receiver = request.POST['users']
// #     sender_user = User.objects.get(id=sender)
// #     receiver_user = User.objects.get(id=receiver)
// #     request.session['receiver_user'] = receiver
// #     get_room = Room.objects.filter(
// #         Q(sender_user=sender_user, receiver_user=receiver_user) | Q(sender_user=receiver_user, receiver_user=sender_user)
// #     )
// #     if get_room:
// #         room_name = get_room[0].room_name
// #     else:
// #         new_room = get_random_string(10)
// #         while True:
// #             room_exists = Room.objects.filter(room_name=new_room)
// #             if room_exists:
// #                 new_room = get_random_string(10)
// #             else:
// #                 create_room = Room.objects.create(sender_user=sender_user, receiver_user=receiver_user, room_name=new_room)
// #                 room_name = create_room.room_name
// #                 break  # Exit the loop once the new room is created

// #     return redirect('room', room_name=room_name)